<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="{{.Config.Path}}/assets/tailwind.css">
    <script src="{{.Config.Path}}/assets/htmx.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="{{.Config.Path}}/" class="navbar-brand">{{.Title}}</a>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-3">
            <div class="col">
                <h1>Jobs</h1>
            </div>
            <div class="col text-right">
                <a href="{{.Config.Path}}/jobs/new" class="btn btn-primary">Add New Job</a>
            </div>
        </div>

        <!-- Advanced Search Form -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Search & Filter Jobs</strong>
                <button class="btn btn-sm btn-outline-secondary float-right" type="button" data-toggle="collapse" data-target="#advanced-search" aria-expanded="false">
                    Advanced Filters
                </button>
            </div>
            <div class="card-body">
                <form hx-get="{{.Config.Path}}/api/jobs/search-paginated"
                      hx-trigger="input changed delay:500ms, submit"
                      hx-indicator="#search-spinner">

                    <!-- Basic Search -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="q" placeholder="Search jobs by name, host, or labels..."
                                   value="{{.SearchQuery}}" autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">Search</button>
                            <a href="{{.Config.Path}}/jobs" class="btn btn-outline-secondary">Clear</a>
                            <span id="search-spinner" class="htmx-indicator spinner-border spinner-border-sm ml-2" role="status"></span>
                        </div>
                    </div>

                    <!-- Advanced Filters (Collapsible) -->
                    <div class="collapse {{if .Criteria}}show{{end}}" id="advanced-search">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="name-filter">Job Name</label>
                                <input type="text" class="form-control" name="name" id="name-filter"
                                       placeholder="Filter by name" value="{{if .Criteria}}{{.Criteria.Name}}{{end}}">
                            </div>
                            <div class="col-md-3">
                                <label for="host-filter">Host</label>
                                <input type="text" class="form-control" name="host" id="host-filter"
                                       placeholder="Filter by host" value="{{if .Criteria}}{{.Criteria.Host}}{{end}}">
                            </div>
                            <div class="col-md-3">
                                <label for="status-filter">Status</label>
                                <select class="form-control" name="status" id="status-filter">
                                    <option value="">All Statuses</option>
                                    <option value="active" {{if and .Criteria (eq .Criteria.Status "active")}}selected{{end}}>Active</option>
                                    <option value="maintenance" {{if and .Criteria (eq .Criteria.Status "maintenance")}}selected{{end}}>Maintenance</option>
                                    <option value="paused" {{if and .Criteria (eq .Criteria.Status "paused")}}selected{{end}}>Paused</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="page-size-filter">Page Size</label>
                                <select class="form-control" name="page_size" id="page-size-filter">
                                    <option value="10" {{if and .SearchResult (eq .SearchResult.PageSize 10)}}selected{{end}}>10</option>
                                    <option value="25" {{if and .SearchResult (eq .SearchResult.PageSize 25)}}selected{{end}}>25</option>
                                    <option value="50" {{if and .SearchResult (eq .SearchResult.PageSize 50)}}selected{{end}}>50</option>
                                    <option value="100" {{if and .SearchResult (eq .SearchResult.PageSize 100)}}selected{{end}}>100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <strong>Job List</strong>
                {{if .SearchResult}}
                <span class="text-muted float-right">
                    {{.SearchResult.TotalCount}} total jobs
                    {{if .SearchQuery}}matching "{{.SearchQuery}}"{{end}}
                </span>
                {{end}}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="jobs-table"
                           hx-ext="sse"
                           sse-connect="{{.Config.Path}}/events"
                           sse-swap="job-status-change:update-job-row"
                           sse-swap="job-created:add-job-row"
                           sse-swap="job-updated:update-job-row"
                           sse-swap="job-deleted:remove-job-row">
                        <thead>
                            <tr>
                                <th>Name & Labels</th>
                                <th>Host</th>
                                <th>Status</th>
                                <th>Last Reported</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body">
                            {{template "job_list_partial.html" .}}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="pagination">
                    {{template "pagination.html" .}}
                </div>
            </div>
        </div>
    </div>

    <script src="{{.Config.Path}}/assets/dashboard.js"></script>
    <input type="hidden" id="dashboard-path" value="{{.Config.Path}}">
    <input type="hidden" id="refresh-interval" value="{{.Config.RefreshInterval}}">
    <input type="hidden" id="sse-enabled" value="{{.Config.SSEEnabled}}">
    <input type="hidden" id="polling-fallback" value="{{.Config.PollingFallback}}">
    <input type="hidden" id="polling-interval" value="{{.Config.PollingInterval}}">

    <script>
        // Initialize real-time updates on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sseEnabled = document.getElementById('sse-enabled').value === 'true';
            const pollingFallback = document.getElementById('polling-fallback').value === 'true';
            const pollingInterval = parseInt(document.getElementById('polling-interval').value) || 5;

            // Set up polling fallback for browsers that don't support SSE
            if (pollingFallback && (!sseEnabled || !window.EventSource)) {
                console.log('Using polling fallback for real-time updates');
                setInterval(function() {
                    refreshJobList();
                }, pollingInterval * 1000);
            } else if (sseEnabled) {
                console.log('Using Server-Sent Events for real-time updates');
            }

            // Custom SSE event handlers
            htmx.on('htmx:sseError', function(event) {
                console.warn('SSE connection error, falling back to polling if enabled');
                if (pollingFallback) {
                    setInterval(function() {
                        refreshJobList();
                    }, pollingInterval * 1000);
                }
            });
        });

        // Custom event handlers for job updates
        function updateJobRow(event) {
            const data = JSON.parse(event.data);
            const jobRow = document.getElementById('job-row-' + data.job_id);
            if (jobRow) {
                // Update status badge
                const statusCell = jobRow.querySelector('.job-status .badge');
                if (statusCell) {
                    statusCell.textContent = data.status;
                    statusCell.className = 'badge badge-' + getBadgeClass(data.status, data.is_failure);
                }

                // Update last reported time
                const lastReportedCell = jobRow.querySelector('.job-last-reported');
                if (lastReportedCell && data.last_reported_at) {
                    lastReportedCell.textContent = formatTimeAgo(new Date(data.last_reported_at));
                }

                // Add visual feedback for updates
                jobRow.classList.add('table-row-updated');
                setTimeout(function() {
                    jobRow.classList.remove('table-row-updated');
                }, 2000);
            }
        }

        function addJobRow(event) {
            // Refresh the entire table when a new job is added
            htmx.trigger('#jobs-table tbody', 'htmx:trigger');
        }

        function removeJobRow(event) {
            const data = JSON.parse(event.data);
            const jobRow = document.getElementById('job-row-' + data.job_id);
            if (jobRow) {
                jobRow.remove();
            }
        }

        function getBadgeClass(status, isFailure) {
            if (isFailure) return 'danger';
            switch (status) {
                case 'active': return 'success';
                case 'maintenance': return 'warning';
                case 'paused': return 'secondary';
                default: return 'secondary';
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return diffInSeconds + 's ago';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
            return Math.floor(diffInSeconds / 86400) + 'd ago';
        }
    </script>
</body>
</html>
